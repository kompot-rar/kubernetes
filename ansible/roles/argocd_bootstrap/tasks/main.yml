---
- name: Ensure python3-kubernetes library is installed
  ansible.builtin.apt:
    name: python3-kubernetes
    state: present
    update_cache: yes
  become: true

- name: Create ArgoCD namespace
  kubernetes.core.k8s:
    name: "{{ argocd_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  become: true

- name: Download ArgoCD install manifest to the master node
  ansible.builtin.get_url:
    url: "{{ argocd_install_url }}"
    dest: "/tmp/argocd-install-{{ argocd_version }}.yaml"
    mode: '0644'
  become: true

- name: Apply ArgoCD install manifest
  kubernetes.core.k8s:
    src: "/tmp/argocd-install-{{ argocd_version }}.yaml"
    state: present
    namespace: "{{ argocd_namespace }}"
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  become: true

- name: Wait for ArgoCD server deployment to be available
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: "{{ argocd_namespace }}"
    name: argocd-server
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: argocd_deployment
  until: argocd_deployment.resources | length > 0 and argocd_deployment.resources[0].status.readyReplicas | default(0) > 0
  retries: 30
  delay: 10
  become: true

- name: Verify installation with kubectl
  ansible.builtin.command:
    cmd: kubectl get pods -n {{ argocd_namespace }} --kubeconfig /etc/rancher/k3s/k3s.yaml
  register: argocd_pods
  changed_when: false
  become: true

- name: Show ArgoCD pods status
  ansible.builtin.debug:
    var: argocd_pods.stdout_lines

- name: Create blog namespace for Cloudflared
  kubernetes.core.k8s:
    name: blog
    api_version: v1
    kind: Namespace
    state: present
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  become: true

- name: Create Cloudflare Tunnel Secret in blog namespace
  kubernetes.core.k8s:
    name: cloudflared-tunnel
    namespace: blog
    kind: Secret
    state: present
    definition:
      apiVersion: v1
      type: Opaque
      stringData:
        token: "{{ cloudflare_tunnel_token }}"
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  become: true
  when: cloudflare_tunnel_token is defined

- name: Create GitHub Container Registry Secret for ArgoCD
  kubernetes.core.k8s:
    name: ghcr-credentials
    namespace: argocd
    kind: Secret
    state: present
    definition:
      apiVersion: v1
      type: kubernetes.io/dockercfg
      metadata:
        labels:
          argocd.argoproj.io/secret-type: repository
      stringData:
        .dockercfg: |
          {
            "ghcr.io": {
              "username": "{{ github_container_registry_user }}",
              "password": "{{ github_container_registry_token }}",
              "email": "noreply@github.com",
              "auth": "{{ (github_container_registry_user + ':' + github_container_registry_token) | b64encode }}"
            }
          }
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  become: true
  when: github_container_registry_token is defined